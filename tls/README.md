# TLS certificates

This directory contains pre-generated X.509 certificates and private keys which are used to secure the communications
between Elastic components using TLS. Those are valid until October 14 2030.

To re-generate those certificates and keys, follow the instructions below.

**:warning: All commands assume you are inside the `tls` directory of the repository.**

## Certificate Authority and Elasticsearch node certificate

Generate a bundle containing the Certificate Authority (CA) and a certificate/key that Elasticsearch nodes will use to
communicate between each other (transport networking layer), both in PKCS #12 format (`.p12`), using the
`elasticsearch-certutil` tool that ships with Elasticsearch:

```none
$ docker run -it \
  -v ${PWD}:/usr/share/elasticsearch/tls \
  docker.elastic.co/elasticsearch/elasticsearch:7.14.1 \
  bin/elasticsearch-certutil cert \
    --days 3650 \
    --keep-ca-key \
    --in tls/instances.yml \
    --out tls/certificate-bundle.zip
```

You will be prompted to enter an optional password to protect both the CA and Elasticsearch keys. Please be aware that
the password you enter here, if not empty, will have to be **added to the Elasticsearch keystore on every node** using
the [`elasticsearch-keystore`][es-keystore] CLI tool (see below)

*:information_source: The pre-generated keys in this repository don't have any password set.*

**:warning: `<none>` indicates that the value can be left empty.**

```none
Enter password for Generated CA: <none>
Enter password for elasticsearch/elasticsearch.p12: <none>
```

> :information_source: In case you entered a password above, execute the following 2 additional commands (Elasticsearch
> *must* be running):
>
> ```console
> $ docker-compose exec -T elasticsearch bin/elasticsearch-keystore add xpack.security.transport.ssl.keystore.secure_password
> Enter value for xpack.security.transport.ssl.keystore.secure_password: <password>
> ```
>
> ```console
> $ docker-compose exec -T elasticsearch bin/elasticsearch-keystore add xpack.security.transport.ssl.truststore.secure_password
> Enter value for xpack.security.transport.ssl.truststore.secure_password: <password>
> ```

Extract the generated certificate archives:

```console
$ sudo unzip certificate-bundle.zip
Archive:  certificate-bundle.zip
   creating: ca/
  inflating: ca/ca.p12
   creating: elasticsearch/
  inflating: elasticsearch/elasticsearch.p12
```

You can then safely remove the Zip file generated by the `elasticsearch-certutil` command in the previous step:

```console
$ sudo rm certificate-bundle.zip
```

At this stage, the structure of the `tls` directory should be:

```tree
tls
├── ca
│   └── ca.p12
├── elasticsearch
│   └── elasticsearch.p12
└── instances.yml
```

## Elasticsearch HTTP certificate and CA PEM certificate

Using the same `elasticsearch-certutil` as above, generate a set of *client* certificates that can be used by other
components (Logstash, Kibana, ...) to communicate with Elasticsearch over HTTPS:

```none
$ docker run -it \
  -v ${PWD}:/usr/share/elasticsearch/tls \
  docker.elastic.co/elasticsearch/elasticsearch:7.14.1 \
  bin/elasticsearch-certutil http
```

When prompted, supply the correct path to the CA certificate archive generated in the previous step. As a reference,
here are the values that were used to create the pre-generated certificates from this repository:

**:warning: `<none>` indicates that the value is to be left empty.**

```none
Generate a CSR? [y/N] n
Use an existing CA? [y/N] y
CA Path: /usr/share/elasticsearch/tls/ca/ca.p12
Password for ca.p12: <none>
For how long should your certificate be valid? [5y] 10y
Generate a certificate per node? [y/N] n
(Enter all the hostnames that you need, one per line.)
elasticsearch
localhost
Is this correct [Y/n] y
(Enter all the IP addresses that you need, one per line.)
<none>
Is this correct [Y/n] y
Do you wish to change any of these options? [y/N] n
Provide a password for the "http.p12" file: <none>
What filename should be used for the output zip file? tls/elasticsearch-ssl-http.zip
```

Extract the generated certificates:

```console
$ sudo unzip elasticsearch-ssl-http.zip
Archive:  elasticsearch-ssl-http.zip
  inflating: elasticsearch/README.txt
  inflating: elasticsearch/http.p12
  inflating: elasticsearch/sample-elasticsearch.yml
   creating: kibana/
  inflating: kibana/README.txt
  inflating: kibana/elasticsearch-ca.pem
  inflating: kibana/sample-kibana.yml
```

You can then safely remove the Zip file generated by the `elasticsearch-certutil` command in the previous step:

```console
$ sudo rm elasticsearch-ssl-http.zip
```

At this stage, the structure of the `tls` directory should be:

```tree
tls
├── ca
│   └── ca.p12
├── elasticsearch
│   ├── README.txt
│   ├── elasticsearch.p12
│   ├── http.p12
│   └── sample-elasticsearch.yml
├── instances.yml
└── kibana
    ├── README.txt
    ├── elasticsearch-ca.pem
    └── sample-kibana.yml
```

## Verification

(Re)start the stack using `docker-compose [up|restart]` to load the certificates generated in the steps described
earlier in this document.

To verify that stack components are successfully communicating with Elasticsearch over TLS, ensure the following
messages are logged to the console.

Logstash:

```log
[INFO ][logstash.outputs.elasticsearch][main] Elasticsearch pool URLs updated {:changes=>{:removed=>[], :added=>[https://logstash-es:xxxxxx@elasticsearch:9200/]}}
[WARN ][logstash.outputs.elasticsearch][main] Restored connection to ES instance {:url=>"https://logstash-es:xxxxxx@elasticsearch:9200/"}
[INFO ][logstash.outputs.elasticsearch][main] ES Output version determined {:es_version=>7}
```

Kibana:

```json
{"type":"log",...,"tags":["status","plugin:elasticsearch@7.14.1","info"],...,"message":"Status changed from yellow to green - Ready","prevState":"yellow","prevMsg":"Waiting for Elasticsearch"}
```

[es-keystore]: https://www.elastic.co/guide/en/elasticsearch/reference/current/elasticsearch-keystore.html
